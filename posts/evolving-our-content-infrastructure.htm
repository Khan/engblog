<!DOCTYPE html> <html> <head> <title>Evolving our content infrastructure | Khan Academy Engineering</title> <link rel="icon" href="/images/favicon.ico"> <meta http-equiv="Content-Type" content="text/html;charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content="We're the engineers behind Khan Academy. We're building a free, world-class education for anyone, anywhere.">  <style>#left-bar .logo,body{font-family:Lato,'Helvetica Neue',Arial,sans-serif;src:url(https://fonts.googleapis.com/css?family=Lato)}#left-bar,#left-bar .logo a{color:#FFF}#left-bar .bio a,#left-bar .logo a{text-decoration:none}#left-bar .logo,#left-bar .subscription-info{text-align:left}body,html{height:100%;margin:0}body{background-color:#F7F8FA;font-size:14px;width:920px}@media (min-width:920px){body{font-size:16px}}@media (max-width:920px){body{width:100%}body.mobile-menu-visible{background-color:#0A2A66}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.inline-author-photo{height:1.6em;width:1.6em;border-radius:.8em;vertical-align:middle;margin-right:4px}.font-awesome-svg{width:1em;height:1em;display:inline-block}#left-bar{box-sizing:border-box;display:table-cell;background-color:#0A2A66;min-width:325px;padding:10px 35px 35px}@media (max-width:920px){#left-bar{display:block;width:100%;padding:0 20px}#left-bar.mobile-visible{padding-bottom:60px}#left-bar:not(.mobile-visible) section{display:none}}#left-bar .logo{font-size:28px;letter-spacing:1px;line-height:1em;margin-bottom:6px;margin-left:-2px;margin-top:0;text-transform:uppercase}#left-bar .logo.mobile{font-size:24px;display:none}@media (max-width:920px){#left-bar .logo.mobile{display:block}#left-bar .logo.mobile a{padding:11px 20px 15px;margin:0 -20px -15px;display:block;text-decoration:none;color:#FFF}#left-bar .logo.mobile svg{opacity:.8;margin-right:-2px;margin-top:1px;height:25px}#left-bar .logo.mobile .text,#left-bar .logo.mobile svg{vertical-align:middle}#left-bar .logo{display:none}}#left-bar .logo .engineering{color:#00E5AE}#left-bar .bio{font-size:12px;line-height:1.4;margin-top:10px}#left-bar .bio,#left-bar .bio *{color:#FFF}#left-bar .bio a:hover{text-decoration:underline}#left-bar .subscription-info .links{font-size:24px}#left-bar .subscription-info .links a{margin-right:7px;text-decoration:none;color:#FFF}#left-bar .subscription-info .links a:hover{border-bottom:1px solid #FFF}#left-bar .subscription-info .links .email{margin-top:-1px}#left-bar .section-heading{color:#F7F8FA;font-size:12px;font-weight:300;letter-spacing:.5px;margin-top:40px;text-transform:lowercase}#left-bar .post-blurb{margin-top:30px;padding-bottom:4px;border-left:1px solid transparent;padding-left:10px;margin-left:-10px;font-size:14px}@media (max-width:920px){#left-bar .post-blurb{border-left:10px solid transparent;padding-left:17px;margin-left:-26px}}#left-bar .post-blurb:first-of-type{margin-top:20px}#left-bar .post-blurb.team-infrastructure{border-color:#E57281}#left-bar .post-blurb.team-web-frontend{border-color:#63BBD9}#left-bar .post-blurb.team-mobile{border-color:#63BB81}#left-bar .post-blurb.team-eng-leads{border-color:#ccc}#left-bar .post-blurb.team-design{border-color:#ab59c6}#left-bar .post-blurb.team-wtf{border-color:#ff00af}#left-bar .post-blurb.team-content-platform{border-color:#ffbf00}#left-bar .post-blurb .title{font-weight:400;margin:0 0 9px}#left-bar .post-blurb .title a{color:#FFF;text-decoration:none}#left-bar .post-blurb .title a:hover{text-decoration:underline}#left-bar .post-blurb .info{font-size:12px}#left-bar .post-blurb .info .author-link{color:#FFF;text-decoration:none;font-weight:700;font-size:11px}#left-bar .post-blurb .info .author-link:hover{text-decoration:underline}#left-bar .meta-section .link-list{margin:0 0 0 4px;padding:0;list-style-type:square}#left-bar .meta-section .link-list li{margin-bottom:10px}#left-bar .meta-section .link-list li a{margin-left:-4px}#left-bar .meta-section .link-list a{color:#FFF;text-decoration:none}#left-bar .meta-section .link-list a:hover{text-decoration:underline}#content{display:table-cell;padding:10px 35px 35px 50px;color:#21242C}@media (max-width:920px){#left-bar .meta-section .link-list{list-style-type:none}#content{padding:10px 20px 50px;display:block}#content.mobile-hidden{display:none}}#content .title a{letter-spacing:1px;margin-bottom:8px;font-size:1.265625em;line-height:1;color:#21242C;text-decoration:none}@media (min-width:920px){#content .title a{font-size:1.5625em}}#content .title a:focus,#content .title a:hover{text-decoration:underline}#content .info .author-link{color:#21242C;font-weight:700;text-decoration:none}#content .info .author-link:hover{text-decoration:underline}#content .info .team-tag{border-radius:.3em;padding:.3em .8em;font-size:.7em;font-weight:500;display:inline-block;color:#fff;margin-left:4px;margin-right:4px}#content .info .team-tag.web-frontend{background-color:#63BBD9}#content .body{margin-top:30px;line-height:1.5;width:580px}@media (max-width:920px){#content .body{width:100%}}#content .body a{color:#1865f2;text-decoration:none}#content .body a:hover{text-decoration:underline}#content .body img{max-width:100%}#content .keep-reading-buttons{display:table;margin-top:30px;width:100%}#content .keep-reading-buttons .keep-reading-cell{display:table-cell;margin:0;padding:0;vertical-align:top;width:50%}progress,sub,sup{vertical-align:baseline}#content .keep-reading-buttons .keep-reading-right{text-align:right}#content .keep-reading-buttons .button{padding:3px 0;display:inline-block;max-width:90%;color:#21242C}.align-center,details{display:block}#content .keep-reading-buttons .button .header{font-size:12px;color:rgba(33,36,44,.64)}#content .keep-reading-buttons .button .post-title{margin-top:8px;color:#1865f2;text-decoration:none;display:block}#content .keep-reading-buttons .button .post-title:hover,abbr[title]{text-decoration:underline}#content .keep-reading-buttons .button.next-post-button{border-right:2px solid;padding-right:10px;margin-right:-10px}#content .keep-reading-buttons .button.prev-post-button{border-left:2px solid;padding-left:10px;margin-left:-10px}#content .keep-reading-buttons .button.team-infrastructure{border-color:#E57281}#content .keep-reading-buttons .button.team-web-frontend{border-color:#63BBD9}#content .keep-reading-buttons .button.team-mobile{border-color:#63BB81}#content .keep-reading-buttons .button.team-eng-leads{border-color:#ccc}#content .keep-reading-buttons .button.team-design{border-color:#ab59c6}#content .keep-reading-buttons .button.team-wtf{border-color:#ff00af}#content .keep-reading-buttons .button.team-content-platform{border-color:#ffbf00}#content .footnote-text{font-size:12px;line-height:normal}.code,.codehilite{background-color:#EEE;border-radius:6px;border:1px solid #CCC;overflow-x:auto;padding:6px;margin:14px 0}.code .ln,.codehilite .ln{color:#AAA}.label{margin-top:1.5em}.caption{text-align:center;font-style:italic}caption,table.data-table th{text-align:left}.align-center{margin-left:auto;margin-right:auto}.literal,code{word-wrap:break-word}caption,figcaption{font-style:italic}caption{caption-side:bottom}table.data-table{margin:0 auto}table.data-table td{text-align:right}table.data-table td,table.data-table th{padding:0 5px;white-space:nowrap}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}.x-scrollable{overflow-x:auto}button,hr,input{overflow:visible}.pullquote{text-align:center;margin-left:58px;margin-right:58px;font-size:24px;font-style:italic;color:#777}/*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{padding:.35em .75em .625em}legend{color:inherit;display:table;max-width:100%;white-space:normal}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}.c,.c1,.cm,.cs,.ge{font-style:italic}.cp,.cs,.gs,.k,.kc,.kd,.kn,.kp,.kr,.kt,.nc,.ne,.nf,.o,.ow{font-weight:700}summary{display:list-item}[hidden],template{display:none}.hll{background-color:#ffc}.c{color:#998}.err{color:#a61717;background-color:#e3d2d2}.cm{color:#998}.cp{color:#999}.c1{color:#998}.cs{color:#999}.gd{color:#000;background-color:#fdd}.gr{color:#a00}.gh{color:#999}.gi{color:#000;background-color:#dfd}.go{color:#888}.gp{color:#555}.gu{color:#aaa}.gt{color:#a00}.kt{color:#458}.m{color:#099}.s{color:#b84}.na{color:teal}.nb{color:#999}.nc{color:#458}.no{color:teal}.ni{color:purple}.ne,.nf{color:#900}.nn{color:#555}.nt{color:navy}.nv{color:teal}.w{color:#bbb}.mf,.mh,.mi,.mo{color:#099}.s2,.sb,.sc,.sd,.se,.sh,.si,.sx{color:#b84}.sr{color:olive}.s1,.ss{color:#b84}.bp{color:#999}.vc,.vg,.vi{color:teal}.il{color:#099}</style>  </head> <body> <div id="left-bar"> <h1 class="logo"> <a href="/"><span aria-label="Khan Academy">Khan</span> <span class="engineering">Engineering</span></a> </h1> <h1 class="logo mobile">  <a id="mobile-menu-button" href="javascript: void 0"> <svg class="font-awesome-svg" viewbox="0 0 1792 1792" aria-hidden="true"><path d="M1664 1344v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45z" fill="#fff"/></svg> <span class="text"><span aria-label="Khan Academy">Khan</span> <span class="engineering">Engineering</span></span> </a> </h1> <section class="bio"> We're the engineers behind <a href="https://www.khanacademy.org">Khan Academy</a>. We're building a free, world-class education for anyone, anywhere. </section> <section class="subscription-info"> <h2 class="section-heading">Subscribe</h2> <div class="links"> <a href="https://twitter.com/KhanAcademyEng"><span class="sr-only">Subscribe with Twitter</span><svg class="font-awesome-svg" viewbox="0 0 1792 1792" aria-hidden="true"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z" fill="#fff"/></svg></a> <a href="/rss.xml"><span class="sr-only">Subscribe with RSS</span><svg class="font-awesome-svg" viewbox="0 0 1792 1792" aria-hidden="true"><path d="M576 1344q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm512 123q2 28-17 48-18 21-47 21h-135q-25 0-43-16.5t-20-41.5q-22-229-184.5-391.5t-391.5-184.5q-25-2-41.5-20t-16.5-43v-135q0-29 21-47 17-17 43-17h5q160 13 306 80.5t259 181.5q114 113 181.5 259t80.5 306zm512 2q2 27-18 47-18 20-46 20h-143q-26 0-44.5-17.5t-19.5-42.5q-12-215-101-408.5t-231.5-336-336-231.5-408.5-102q-25-1-42.5-19.5t-17.5-43.5v-143q0-28 20-46 18-18 44-18h3q262 13 501.5 120t425.5 294q187 186 294 425.5t120 501.5z" fill="#fff"/></svg></a> </div> </section> <section> <h2 class="section-heading">Latest posts</h2> <div class="post-blurb team-engineering"> <h3 class="title"> <a href="/posts/eng-principles-help-scale.htm">How Engineering Principles Can Help You Scale</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/marta.jpg" aria-hidden="true" role="presentation"> <a class="author-link">Marta Kosarchyn</a> on August 21<sup aria-hidden="true">st</sup> </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/windows-high-contrast-mode.htm">Making Websites Work with Windows High Contrast Mode</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/diedra.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/dierat">Diedra Rater</a> on March 21<sup aria-hidden="true">st</sup> </div> </div> <div class="post-blurb team-content-platform"> <h3 class="title"> <a href="/posts/kotlin-for-python-developers.htm">Kotlin for Python developers</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/aasmundeldhuset.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://eldhuset.net/">Aasmund Eldhuset</a> on Nov 29, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/using-static-analysis-in-Python-and-JavaScript-to-make-your-system-safer.htm">Using static analysis in Python, JavaScript and more to make your system safer</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevindangoor.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://blueskyonmars.com/">Kevin Dangoor</a> on Jul 26, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/kotlin-adoption.htm">Kotlin on the server at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/colin.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/cjfuller">Colin Fuller</a> on Jun 28, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/original-serverless.htm">The Original Serverless Architecture is Still Here</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevindangoor.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://blueskyonmars.com/">Kevin Dangoor</a> on May 31, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/architects-at-khan.htm">What do software architects at Khan Academy do?</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevindangoor.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://blueskyonmars.com/">Kevin Dangoor</a> on May 14, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/khanalytics.htm">New data pipeline management platform at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/ragini.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/guptaragini">Ragini Gupta</a> on Apr 30, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/python-refactor-3.htm">Untangling our Python Code</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/carter.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://carterjbastian.com/">Carter J. Bastian</a> on Apr 16, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/slicker.htm">Slicker: A Tool for Moving Things in Python</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/ben-kraft.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.benkraft.org/">Ben Kraft</a> on Apr 2, 2018 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/python-refactor-1.htm">The Great Python Refactor of 2017 And Also 2018</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Mar 19, 2018 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/working-remotely.htm">Working Remotely</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/scottgrant.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/scotchfield">Scott Grant</a> on Oct 2, 2017 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/tips-for-code-reviews.htm">Tips for giving your first code reviews</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/hannah.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://hannahblumberg.com/">Hannah Blumberg</a> on Sep 18, 2017 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/lets-reduce.htm">Let&#x27;s Reduce! A Gentle Introduction to Javascript&#x27;s Reduce Method</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/joshcomeau.jpeg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/joshwcomeau">Josh Comeau</a> on Jul 10, 2017 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/creating-query-components-with-apollo.htm">Creating Query Components with Apollo</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/brian-genisio.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/BrianGenisio">Brian Genisio</a> on Jun 12, 2017 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/react-native-monorepo.htm">Migrating to a Mobile Monorepo for React Native</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/jared.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://jaredforsyth.com/">Jared Forsyth</a> on May 29, 2017 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/memcached-fms.htm">Memcached-Backed Content Infrastructure</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/ben-kraft.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.benkraft.org/">Ben Kraft</a> on May 15, 2017 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/memcached-profiling.htm">Profiling App Engine Memcached</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/ben-kraft.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.benkraft.org/">Ben Kraft</a> on May 1, 2017 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/flex-language-shootout.htm">App Engine Flex Language Shootout</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/amos-latteier.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/latteier">Amos Latteier</a> on Apr 17, 2017 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/new-oss-activity.htm">What&#x27;s New in OSS at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/brian-genisio.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/BrianGenisio">Brian Genisio</a> on Apr 3, 2017 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/automating-app-store-screenshots.htm">Automating App Store Screenshots</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/bryanclark.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.bryanjclark.com/">Bryan Clark</a> on Mar 27, 2017 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/its-okay-to-break-things.htm">It&#x27;s Okay to Break Things: Reflections on Khan Academy&#x27;s Healthy Hackathon</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kimeriegreen.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/Kimerie">Kimerie Green</a> on Mar 6, 2017 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/interning-at-khan-academy.htm">Interning at Khan Academy: from student to intern</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/shadajladdad.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://shadaj.me">Shadaj Laddad</a> on Dec 12, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/prototyping-with-framer.htm">Prototyping with Framer</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/nickbreen.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/MrNickBreen">Nick Breen</a> on Oct 3, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/evolving-our-content-infrastructure.htm">Evolving our content infrastructure</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/wchargin.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://wchargin.github.io">William Chargin</a> on Sep 19, 2016 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/a-really-small-app.htm">Building a Really, Really Small Android App</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/charliemarsh.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.crmarsh.com">Charlie Marsh</a> on Aug 22, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/a-case-for-time-tracking.htm">A Case for Time Tracking: Data Driven Time-Management</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/olivernorthwood.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/allofthenorthwood">Oliver Northwood</a> on Aug 8, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/time-management-multiple-authors.htm">Time Management at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/khanacademy.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://www.khanacademy.org/careers">Several Authors</a> on Jul 25, 2016 </div> </div> <div class="post-blurb team-eng-leads"> <h3 class="title"> <a href="/posts/healthy-hackathons.htm">Hackathons Can Be Healthy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/tomyedwab.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.arguingwithalgorithms.com">Tom Yedwab</a> on Jul 11, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/transaction-safety.htm">Ensuring transaction-safety in Google App Engine</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Jun 27, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/user-write-lock.htm">The User Write Lock: an Alternative to Transactions for Google App Engine</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Jun 20, 2016 </div> </div> <div class="post-blurb team-eng-leads"> <h3 class="title"> <a href="/posts/engineering-principles.htm">Khan Academy&#x27;s Engineering Principles</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/benkamens.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://bjk5.com">Ben Kamens</a> on Jun 6, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/shortest-regex.htm">Minimizing the length of regular expressions, in practice</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on May 23, 2016 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/introducing-swifttweaks.htm">Introducing SwiftTweaks</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/bryanclark.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.bryanjclark.com/">Bryan Clark</a> on May 9, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/autonomous-dumbledore.htm">The Autonomous Dumbledore</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/evykassirer.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://www.evykassirer.com/">Evy Kassirer</a> on Apr 25, 2016 </div> </div> <div class="post-blurb team-eng-leads"> <h3 class="title"> <a href="/posts/career-development.htm">Engineering career development at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/beneater.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/beneater">Ben Eater</a> on Apr 11, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/aphrodite-inline-css.htm">Inline CSS at Khan Academy: Aphrodite</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/jamiewong.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://jamie-wong.com">Jamie Wong</a> on Mar 29, 2016 </div> </div> <div class="post-blurb team-mobile"> <h3 class="title"> <a href="/posts/starting-android.htm">Starting Android at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/benkomalo.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/benkomalo">Ben Komalo</a> on Feb 29, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/translation_assistant.htm">Automating Highly Similar Translations</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevinbarabash.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/kevinb7">Kevin Barabash</a> on Feb 15, 2016 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/snippet-server.htm">The weekly snippet-server: open-sourced</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Feb 1, 2016 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/stories-from-interns.htm">Stories from our latest intern class</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/khanacademy.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://www.khanacademy.org/careers/interns">2015 Interns</a> on Dec 21, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/kanbanning-learnstorm-dev-process.htm">Kanbanning the LearnStorm Dev Process</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevindangoor.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://blueskyonmars.com/">Kevin Dangoor</a> on Dec 7, 2015 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/js-packaging-http2.htm">Forgo JS packaging? Not so fast</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Nov 23, 2015 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/switching-to-slack.htm">Switching to Slack</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/benjaminpollack.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://bitquabit.com/">Benjamin Pollack</a> on Nov 9, 2015 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/receiving-feedback.htm">Receiving feedback as an intern at Khan Academy</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/davidwang.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://ourracingthoughts.com/author/d15w/">David Wang</a> on Oct 26, 2015 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/translation-server.htm">Schrödinger&#x27;s deploys no more: how we update translations</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/chelseavoss.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://csvoss.github.io/">Chelsea Voss</a> on Oct 12, 2015 </div> </div> <div class="post-blurb team-infrastructure"> <h3 class="title"> <a href="/posts/i18nize-templates.htm">i18nize-templates: Internationalization After the Fact</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/csilvers.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/csilvers">Craig Silverstein</a> on Sep 28, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/making-thumbnails-fast.htm">Making thumbnails fast</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/wchargin.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://wchargin.github.io">William Chargin</a> on Sep 14, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/copy-pasting-more-than-just-text.htm">Copy-pasting more than just text</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/samlau.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/SamLau95">Sam Lau</a> on Aug 31, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/no-cheating-allowed.htm">No cheating allowed!!</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/philliplemons.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://philliplemons.com/">Phillip Lemons</a> on Aug 17, 2015 </div> </div> <div class="post-blurb team-design"> <h3 class="title"> <a href="/posts/fun-with-slopfields.htm">Fun with slope fields, css and react</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/marcosojeda.jpg" aria-hidden="true" role="presentation"> <a class="author-link" href="http://generic.cx/">Marcos Ojeda</a> on Aug 5, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/new-employees-primer.htm">Khan Academy: a new employee&#x27;s primer</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/rileyshaw.png" aria-hidden="true" role="presentation"> <a class="author-link" href="http://rileyjshaw.com">Riley Shaw</a> on Jul 20, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/evil-puzzle.htm">How wooden puzzles can destroy dev teams</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/johnsullivan.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/brownhead">John Sullivan</a> on Jul 6, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/i18n-babel-plugin.htm">Babel in Khan Academy&#x27;s i18n Toolchain</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/kevinbarabash.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/kevinb7">Kevin Barabash</a> on Jun 22, 2015 </div> </div> <div class="post-blurb team-web-frontend"> <h3 class="title"> <a href="/posts/tota11y.htm">tota11y - an accessibility visualization toolkit</a> </h3> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/jordanscales.png" aria-hidden="true" role="presentation"> <a class="author-link" href="https://github.com/jdan">Jordan Scales</a> on Jun 8, 2015 </div> </div> </section> <section class="meta-section"> <h2 class="section-heading">Meta</h2> <ul class="link-list"> <li><a href="https://github.com/Khan/engblog">About this blog</a></li> <li><a href="https://www.khanacademy.org/about">KA's mission</a></li> <li><a href="https://github.com/khan/engblog/issues">Report a bug</a></li> <li><a id="activate-tota11y" href="javascript: void 0">Activate tota11y</a></li> </ul> </section> </div> <main id="content"> <article class="post"> <h1 class="title"> <a href="/posts/evolving-our-content-infrastructure.htm"> Evolving our content infrastructure </a> </h1> <div class="info"> <img class="inline-author-photo" src="/images/author-icons/wchargin.png" aria-hidden="true" role="presentation"> <span class="sr-only">by</span> <a class="author-link" href="https://wchargin.github.io">William Chargin</a> on Sep 19, 2016 </div> <div class="body"> <p>Every month, millions of learners use Khan&nbsp;Academy in languages other than English. Over the past few years, we&rsquo;ve built the tools to get our content translated for non-English learners, but the experience has always been far from perfect&mdash;for both our learners and our translators.</p> <p>Two weeks ago, we hit a major milestone in improving this experience. Khan&nbsp;Academy users in Mexico may have noticed two exciting new things about our website:</p> <ul> <li> <p>users on Telcel, Mexico&rsquo;s largest cell network, <a href="https://www.khanacademy.org/r/zero-rating-learn-more">can now access Khan&nbsp;Academy free of data charges on both native apps and es.zero.khanacademy.org</a>, thanks to partnership with the Carlos&nbsp;Slim Foundation and Telcel, and</p> </li> <li> <p>all content on the Spanish-language Khan Academy&nbsp;site should now be available completely in Spanish, with no interspersed English!</p> </li> </ul> <p>These are both important milestones for our learners, our engineering team, and our team of translators. In this blog post, I&rsquo;ll focus on the second one, discussing the infrastructure changes and optimizations that we needed to make in order to achieve this zero-English goal, and how we&rsquo;ll adapt these changes to more languages.</p> <h2>What&rsquo;s the problem?</h2> <p>Of course, <a href="/posts/translation-server.htm">translations aren&rsquo;t new to Khan&nbsp;Academy</a>. All our natural language content and all our user interface strings go through a third-party translations service called <a href="https://crowdin.com/">Crowdin</a>, and <a href="/posts/translation_assistant.htm">we&rsquo;ve even built extensive tooling</a> to make this as easy as possible for translators. Indeed, our translations are updated many times per day, and our teams around the world translate millions of words monthly to help make Khan&nbsp;Academy available in other languages! Yet, until recently, we continued to have significant portions of our site appearing in English.</p> <figure> <img src="/images/chameleon/partially-translated-exercise.png" alt="A screenshot of an exercise whose title and description are in Georgian, but about half of whose content is in English."> <figcaption> Though much of this exercise is translated, some crucial parts remain in English, so the exercise is effectively useless to non-English learners. <a href="/images/chameleon/partially-translated-exercise.png">(Larger view.)</a> </figcaption> </figure> <p>There are two primary sources of untranslated content on our site: new content and changed content.</p> <p>Our content creators work in English, so all new content that they add appears untranslated initially. We&rsquo;ve long had a solution to this, though: each topic has a set of &ldquo;listed locales,&rdquo; which we use to limit the locales in which we show the enclosed content. We can simply set new content to only be listed in English; then, we can gradually add the content to more and more locales as translators translate it. While this may not be optimal (as it requires manually updating these listed locales whenever translations are completed), it works fine and solves the problem of new content appearing untranslated.</p> <p>The larger problem is changes to existing content that&rsquo;s already live on international sites. If we add a section to an article, or introduce some new problem types in an exercise, then those new strings will be visible immediately&mdash;but they won&rsquo;t yet have translations, so they&rsquo;ll appear in English. Even small changes to existing content and metadata, like removing a space at the end of a video description, or changing a straight quote to a smart quote in an article title, will technically be new strings, so will appear untranslated.</p> <p>This is a pretty big problem, because our content creators publish and update content dozens of times per day, and each publish risks reverting content to English. This wipes away translators&rsquo; work, and immediately exposes learners to a language that they may not understand.</p> <p>We&rsquo;ve been thinking about this for a while, but it is a hard problem. Ideally, we want to give translators the ability to fix <em>a specific version</em> of the site, translate it, and have that version appear live for their translated site. Any further updates from the English site wouldn&rsquo;t be visible on the international site until translators decide to translate it, actually translate it, and publish their updates to their site.</p> <p>The first step in implementing this is simply making it possible to display different versions of the content tree on non-English sites. To actually implement this, we needed to make some wide-reaching changes to the infrastructure behind our content system.</p> <h2>A bird&rsquo;s-eye view of our content architecture</h2> <p>Our site runs on top of a custom CMS. To understand the required infrastructural changes, we need to understand a bit of how the CMS works.</p> <p>Each content entity on our site&mdash;videos, articles, and exercises, and also the topics into which they&rsquo;re arranged&mdash;is stored in an immutable Python object, called a <code>Video</code> (etc.). The cache of all these frozen models is stored in memory on each instance, so all requests have essentially instant access to all of our content. For evident reasons, we call this cache the <em>frozen model store</em>, or&nbsp;FMS, and we&rsquo;ll be coming back to it a&nbsp;lot as it&rsquo;s the core data structure for the site!</p> <p>When a content creator makes a change to, say, update the description of a video, we create a new <code>VideoRevision</code> entity on the server; just like the corresponding frozen model, this entity contains all the metadata for the content. The server also sets the &ldquo;editing head&rdquo; for the relevant video to point to the new revision, but no changes are made to the frozen model store until the content creator <em>publishes</em> the change. At publish time, we grab the most recent revisions for all the entities that the content creator wants to publish, and all the currently live revisions for everything unchanged (the vast majority). We then go through and create the frozen models for each revision, adding some metadata as we go.</p> <figure> <img src="/images/chameleon/cms.png"> <figcaption> The CMS editor view. At left, you can see the structure of the topics in the content tree. At right, a particular content item is shown; editing any field will create a new <tt>VideoRevision</tt> entity. <a href="/images/chameleon/cms.png">(Larger view.)</a> </figcaption> </figure> <p>At this point, we&rsquo;ve created a new frozen model store for the new version of the site. To update the live site, we simply flip a global setting called <code>last_published_commit</code>, which contains the&nbsp;SHA-1&nbsp;hash of the currently live FMS. At the beginning of every request, each instance will make sure that it has the most recent SHA, and will pull in the latest version of the FMS if it&rsquo;s out of date, evicting the old one from its cache. All queries to our content go through the frozen model store, and all relevant caches are keyed against the FMS SHA, so the effect is that the entire site is atomically updated in about a second.</p> <p>If you&rsquo;d like to read more, <a href="http://www.tomyedwab.com/home/">Tom</a> has written about <a href="http://www.arguingwithalgorithms.com/posts/14-01-03-content-store">how he designed this CMS</a> and <a href="http://www.arguingwithalgorithms.com/posts/14-01-03-content-implementation">how he implemented it</a>. But all you really need to know for now is that the whole frozen model store is keyed by SHA and stored in a big in-memory cache.</p> <h2>The one-line solution</h2> <p>There is a conceptually simple way to achieve our goal of freezing a version of the site to appear in Spanish. All we need to do is identify the SHA of the content version that we want to freeze, and then use that SHA in place of the default SHA on the Spanish-language site, by hooking into the global setting.</p> <p>It turns out that this is pretty easy to implement, too. We can simply change our <code>last_published_commit</code> string to a <code>last_published_commits</code> dictionary, mapping each locale to its specific content version (with the semantics that locales not in the dictionary use the English tree). When evicting caches, we just don&rsquo;t evict the FMS for <em>any</em> of the currently live versions.</p> <p>This actually works impressively well. Because all content accesses are keyed against the SHA, and the SHA is computed based on the locale, all content accesses are now effectively keyed by locale as well. There were only a few places that needed to be updated further, and these were the codepaths that worked directly with the frozen model store itself (like the content publish process, which <em>sets</em> the global SHA setting, as well as our scripts to prime caches against a new version of the site before it goes live).</p> <p>The fun part, as with any infrastructure work, is in anticipating and dealing with the downstream effects of this change.</p> <h2>Memory</h2> <p>You&rsquo;ve probably spotted that this potentially doubles the memory usage of our content system: we&rsquo;re now storing <em>two</em> similarly-sized content trees in instance memory. The first question is whether we can handle that at all.</p> <p>Our frozen model store is only about 34&nbsp;megabytes as stored in the datastore, but this is with all entities pickled and the entire store compressed. We cache the decompressed and unpickled form in instance memory, because we demand instant access to content. We checked on our production instances, and found that this came out to 313&thinsp;MB. The App&nbsp;Engine instances that we use only have 512&thinsp;MB of&nbsp;RAM, so we clearly wouldn&rsquo;t be able to store two of these in memory at once. It was optimization time.</p> <p>As usual, there was some really low-hanging fruit. We did some memory analysis using <a href="https://pythonhosted.org/Pympler/library/asizeof.html">Python&rsquo;s <code>asizeof</code> library</a>, and saw that articles were taking up a disproportionate amount of space. Upon closer inspection, the cause became clear&mdash;out of videos, exercises, articles, and topics (our four content kinds), articles are the only kind with any non-trivial content stored in the FMS other than metadata. For instance, all of our video content is hosted entirely on&nbsp;YouTube. But we were storing the body of every article as <a href="https://github.com/khan/perseus#readme">Perseus content</a> in the frozen model store.</p> <p>The frozen model store wasn&rsquo;t intended to store this kind of data, but obviously we have to store it somewhere. Our solution was simple: just don&rsquo;t store the content in the FMS, and instead delegate to the <code>ArticleRevision</code> from which the <code>Article</code> in the FMS was originally created. This is essentially as simple as adding an <code>@property</code> to the <code>Article</code> class:</p> <div class="codehilite"><pre><span class="nd">@property</span>
<span class="nd">@request_cache.cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">perseus_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># (shadows the old `perseus_content` attribute)</span>
    <span class="n">revision</span> <span class="o">=</span> <span class="n">ArticleRevision</span><span class="o">.</span><span class="n">get_by_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sha</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">revision</span><span class="o">.</span><span class="n">perseus_content</span>
</pre></div> <p>Because our revision types are <em>also</em> immutable, we don&rsquo;t lose any atomicity guarantees by doing this. That is, we have an overall SHA for the frozen model store, and each frozen article also has a revision SHA that&rsquo;s stored in the FMS; the composition of two frozen SHAs is still a frozen SHA.</p> <p>The major concern here, then, is that the data access is no longer instant. But our <code>request_cache.cache()</code> decorator on the getter above fixes that, by (unsurprisingly) caching the datastore value for the duration of the request. It&rsquo;s rare for a request to need to fetch the full content of multiple articles&mdash;usually, you&rsquo;re either displaying the metadata for a whole bunch of them in a list, or you&rsquo;re actually viewing just a single article&mdash;but this does happen when we, e.g., traverse the entire content tree. In that case, we can fetch all the relevant data with a multi-get and populate the caches, to avoid degrading to a bunch of sequential, blocking RPCs. So the overall performance hit is at most one RPC per request, which is totally fine; in return, we immediately lopped off about 60&thinsp;MB of memory.</p> <p>As we continued to look at the distribution of data, the long tail fell off quickly, and we ate all the low-hanging fruit without achieving the memory reduction that we were hoping for. A&nbsp;lot of our data was just normal dictionaries containing information that we couldn&rsquo;t really see a way to optimize, like lists of problem types that apply to any particular exercise (stored as IDs, so not really compressible).</p> <p>But a closer look revealed that the overhead of these containers themselves&mdash;primarily Python <code>dict</code>s&mdash;was a significant contributor to our memory usage! We found that the standard library&rsquo;s <code>namedtuple</code> was more memory-efficient, but <code>namedtuple</code> has a different interface&mdash;<code>point.x</code> instead of <code>point['x']</code>&mdash;and we didn&rsquo;t want to have to update all users (tricky in a dynamically typed codebase!). Also, using a <code>namedtuple</code> would have prevented us from adding or removing fields in a way backward compatible with existing pickled objects; <code>namedtuple</code>s really are just tuples with the names stored on the class object.</p> <p>To solve these, we created a type called a <code>tuplemap</code>, with the following key properties:</p> <ol> <li>the interface is like a <code>dict</code>;</li> <li>memory usage is like a tuple; and</li> <li>when pickled and unpickled, the ordering and naming of fields is flexible, like a <code>dict</code> and unlike <code>collections.namedtuple</code>.</li> </ol> <p>If this sounds appealing, we&rsquo;re open-sourcing <a href="https://gist.github.com/chrisklaiber/46b24723d93182e3f81068572566b18a"><code>tuplemap</code>, as well as its successor, <code>namedmap</code></a>, and also their tests, for use in your code today! Go ahead and check &rsquo;em out.</p> <p>By replacing some of our heavier collections with this type, and also interning the strings used as keys when unpickling the objects, we knocked about 120&thinsp;MB off of the frozen model store size. This was sufficient&mdash;we were good to go on the memory front!</p> <h2>The fly in the ointment</h2> <p>There was just one tiny catch to all of the above, and it&rsquo;s the dirty little secret of the frozen model store: not everything is actually immutable.</p> <p>In addition to the videos, exercises, and articles that power much of our content, we have entire <a href="https://www.khanacademy.org/computing/computer-programming">computer programming</a> and <a href="https://www.khanacademy.org/computing/computer-science">computer science</a> curricula. We&rsquo;d be remiss to teach these without offering a way for users to create their own programs, and so indeed we do offer programming playground environments, called &ldquo;scratchpads,&rdquo; for JavaScript, ProcessingJS, HTML, and SQL. We also use these scratchpads in our official content, both for CS tutorials and as <a href="https://www.khanacademy.org/partner-content/pixar/effects/particle/p/fireworks-simulator">demos</a> and <a href="https://www.khanacademy.org/partner-content/pixar/crowds/crowds2/p/building-snake-bots">explorations</a> on the rest of the site as well.</p> <figure> <a href="https://gfycat.com/AggressiveAlertCrow"> <img src="/images/chameleon/scratchpad-demo.gif"> </a> <figcaption> A demo of scratchpads in action. The live code editing helps make it a great learning environment for beginners, as you can change the parameters and watch the output respond in real time. <a href="https://gfycat.com/AggressiveAlertCrow">(Larger view.)</a> </figcaption> </figure> <p>But these scratchpads are clearly fundamentally different from the rest of our content, in that they can be created by users. When a user creates a scratchpad, we obviously don&rsquo;t add it to the frozen model store (we have about 14&nbsp;million of them, for one thing!), and additionally scratchpads&rsquo; content is mutable. So when we use a scratchpad as part of our official content tree, the only thing we include in the frozen model store is the scratchpad&rsquo;s database key.</p> <p>Consequently, scratchpads can be changed outside of the normal publish process: just clicking the &ldquo;Save&rdquo; button on an official scratchpad makes the changes instantly visible to all users. This means that freezing a version of the frozen model store actually isn&rsquo;t sufficient to freeze the whole content tree.</p> <p>In an ideal world, we would already have frozen scratchpads to begin with, as a normal part of the content tree and separate from user-generated scratchpads. Perhaps in an ideal world, which is of course free of any &ldquo;time constraints,&rdquo; we might have taken this opportunity to introduce such a type. But this would be a pretty large undertaking, cutting across the content infrastructure, the actual content itself (we&rsquo;d need to replace the database keys with newly reified scratchpads), the scratchpad viewing interface, and the scratchpad editing interface. We were really hoping that we could avoid undertaking that eight-week project.</p> <p>Instead, we tried to redefine the problem. The underlying issue was that we were worried about English text seeping in to our frozen tree. Most of scratchpads&rsquo; content is code, which isn&rsquo;t translated anyway, and voiceovers for our &ldquo;talkthrough&rdquo; tutorials, which are irrelevant because they&rsquo;re not text-based (and they&rsquo;re already translated separately). It turned out that the only natural language text in scratchpads boiled down to four fields of metadata: the title, the description, the criteria for peer-evaluating projects, and the suggested &ldquo;next steps&rdquo; after interacting with a scratchpad.</p> <p>So, instead of making scratchpads <em>themselves</em> frozen, we introduced a new entity type: the <code>PartialScratchpad</code>, with just these four properties. Whenever we publish content, we grab the latest version of these natural-language properties from the live scratchpads, and attach them to partial scratchpads. Then, we added more <code>@property</code>s to the main scratchpad model, making them delegate to the <code>PartialScratchpad</code> for official scratchpads, or fall back to the live data for user-generated scratchpads.</p> <p>This was pretty easy to implement, is totally safe, and doesn&rsquo;t have any downstream effects to other parts of the codebase. Although it&rsquo;s not a perfect solution, it is a step in the right direction; if we do decide to fully freeze scratchpads later, we&rsquo;ll have a place to start and a way to gradually migrate data.</p> <h2>Lessons</h2> <p>As usual, this is as much &ldquo;lessons reinforced&rdquo; as &ldquo;lessons learned&rdquo;! But that doesn&rsquo;t make them any less valuable.</p> <ul> <li> <p><strong>Strive for immutability.</strong> Our content system was <em>almost</em> entirely immutable, and patching the part that wasn&rsquo;t did not pose a big problem. If we had had to touch every API&nbsp;call that viewed, edited, or published content, <em>or</em> used a cached version of any one of those&mdash;which is basically the whole site&mdash;this process would have taken <em>far</em> longer and have had far more bugs.</p> </li> <li> <p><strong>Identify underlying requirements, then look for 80&ndash;20&nbsp;optimizations.</strong> Our approach to scratchpads didn&rsquo;t totally fix the underlying problem, but it certainly didn&rsquo;t make it any worse, and it totally satisfied our real goal of eliminating all English-language text from the Spanish site.</p> </li> <li> <p><strong>Improving Python memory usage is tricky, but totally possible.</strong> With the help of some good tools, we were able to successfully identify the hotspots; with the help of some Python features like <code>__slots__</code>, we were able to efficiently optimize them.</p> </li> </ul> <h2>Results and future work</h2> <p>Khan&nbsp;Academy&rsquo;s Spanish site now successfully uses a different content version than the English site. The servers are able to hold both versions of the content comfortably in memory. We can show and hide content on the Spanish tree independently of the English tree, so we can elect to show content only after it&rsquo;s been translated.</p> <p>Moving forward, we have a few major goals. Recall that our original vision was to allow translators to selectively pull in updated content from the English site&mdash;building the frontend and the backend for that system is at the top of our list. Then, we&rsquo;ll figure out a way to scale this whole system to more than two content trees: clearly, we can&rsquo;t just keep reducing the memory usage forever; we&rsquo;ll need to fundamentally change the way that content is stored and/or accessed. We&rsquo;ve got some ideas&hellip;</p> <p>Finally, I&nbsp;want to highlight that I&rsquo;ve used the word&nbsp;&ldquo;we&rdquo; an awful lot in this post, and not in the mathematical I-really-mean-&ldquo;I&rdquo; sense: this work is due to many of the fantastic people on our infrastructure and frontend teams, of which I&rsquo;m honored to be a part. Do these problems sound interesting? <a href="https://www.khanacademy.org/careers">Come join us!</a></p> </div> </article> <div class="keep-reading-buttons"> <div class="keep-reading-cell keep-reading-left"> <div class="button prev-post-button team-mobile"> <div class="header">previous post</div> <a href="/posts/a-really-small-app.htm" class="post-title">Building a Really, Really Small Android App</a> </div> </div> <div class="keep-reading-cell keep-reading-right"> <div class="button next-post-button team-web-frontend"> <div class="header">next post</div> <a href="/posts/prototyping-with-framer.htm" class="post-title">Prototyping with Framer</a> </div> </div> </div> </main> <script>document.getElementById("mobile-menu-button").onclick=function(){var e=document.body,t=document.getElementById("left-bar"),a=document.getElementById("content");"mobile-visible"===t.className?(e.className="",t.className="",a.className=""):(e.className="mobile-menu-visible",t.className="mobile-visible",a.className="mobile-hidden")};var totallyActivated=!1;document.getElementById("activate-tota11y").onclick=function(){if(totallyActivated)console.log("Tota11y already activated. Doing nothing.");else{var e=document.createElement("script");e.src="/javascript/tota11y.min.js",document.head.appendChild(e),totallyActivated=!0}},function(e,t,a,n,c,l,o){e.GoogleAnalyticsObject=c,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,l=t.createElement(a),o=t.getElementsByTagName(a)[0],l.async=1,l.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(l,o)}(window,document,"script",0,"ga"),ga("create","UA-65856931-1","auto"),ga("send","pageview");</script> </body> </html> 